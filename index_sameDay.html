<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <title>Warehouse KPI Analysis â€“ Floship</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  </head>
  <body>
    <div class="container">
      <div class="mb-3">
        <label for="formFile" class="form-label">Input CSV File here</label>
        <div class="d-flex flex-row align-items-center" style="gap: 10px;">
          <input class="form-control" type="file" id="uploadFile" accept=".csv">
          <button id="uploadConfirm" type="button" class="btn btn-primary">Upload</button>
        </div>

      </div>
    </div>
    <div id="result"></div>
    <div id="sameDay"></div>
    <div class="chartContainer d-flex flex-wrap container" id="chart-container">

    </div>


    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>


    <script type="text/javascript">
    // src="scriptRevamp_sameDay.js">
    
    const uploadConfirm = document.getElementById("uploadConfirm"); //get the button tag for triggering the parsing
    const getFile = document.getElementById("uploadFile"); //get the file
    const loopChart = document.getElementById("chart-container");
    let threePl_name = []; //store the threepl_name from csv
    let unique_threePl_name = []; //store the non-duplicated threepl_name
    let object = {};
    let dataStore = [];
    //let dataStore2 = [];

    //parsing the data using papaparse
    uploadConfirm.addEventListener("click", () => {
      Papa.parse(getFile.files[0], {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          //getting the threepl_name
          results.data.map((row) => {
            threePl_name.push(row.threepl_name);
          });
          console.log(threePl_name);
          unique_threePl_name = [...new Set(threePl_name)]; //remove duplicate
          console.log(unique_threePl_name);


          unique_threePl_name.forEach((name) => {

            // configure the object variable
            object["threePl_name"] = name;
            object["meet"] = 0;
            object["fail"] = 0;
            object["total"] = 0;
            object["fsnumber"] = []; // add key value in object
            dataStore.push(object);
            object = {};
          });
          console.log(dataStore);
          //console.log(dataStore);


          //looping through row with all the logic
          results.data.map((row) => {

            slaMeet(row.WarehouseSLA, row.threepl_name, row.fsnumber);

          });
          console.log(dataStore);

          //make container for chart
          var x ="";
          dataStore.map((data, index) => {
            x = x + `<div class='card w-50'><div class='card-body'><div id='chart${index}'>` + "</div></div></div>";
            // console.log(`#chart${index}`)

          })
          loopChart.innerHTML = x;


          //make chart https://apexcharts.com/
          dataStore.map((data, index) => {
            new ApexCharts(document.querySelector(`#chart${index}`),
            {
              chart: {
                height: 280,
                //colors: ['#F72C00', '#E91E63'],
                type: "donut",
              },
              title: {
                  text: data.threePl_name,
                  align: "center"
              },
              fill: {
                colors: [ "#99CC99", "#F20734"]
              },

              series: [data.meet, data.fail],

              plotOptions: {
                pie: {
                  donut: {
                    value: {
                      show: true,
                      fontsize: '16px',
                      color: '#99CC99'
                    },
                    value: {
                      show: false,
                      fontsize: '16px',
                      color: '#F20734'
                    }
                  },
                },
              },

              labels: ["Meet: " + data.meet, "Not Meet: " + data.fail],
              legend: {
                show: true,
                showForSingleSeries: false,
                showForNullSeries: true,
                showForZeroSeries: true,
                position: 'bottom',
                horizontalAlign: 'center',
                floating: false,
                fontSize: '14px',
                fontFamily: 'Helvetica, Arial',
                fontWeight: 400,
                formatter: undefined,
                inverseOrder: false,
                width: undefined,
                height: undefined,
                tooltipHoverFormatter: undefined,
                customLegendItems: [],
                offsetX: 0,
                offsetY: 0,
                labels: {
                    colors: undefined,
                    useSeriesColors: false
                },
                markers: {
                    width: 12,
                    height: 12,
                    strokeWidth: 0,
                    strokeColor: '#fff',
                    fillColors: [ "#99CC99", "#F20734"],
                    radius: 12,
                    customHTML: undefined,
                    onClick: undefined,
                    offsetX: 0,
                    offsetY: 0
                },
                itemMargin: {
                    horizontal: 5,
                    vertical: 0
                },
                onItemClick: {
                    toggleDataSeries: true
                },
                onItemHover: {
                    highlightDataSeries: true
                },
            }
            }).render()
          })
        },
      });
    });

    // LOGIC STARTS HERE

    const slaMeet = (sla, threePl_name, fsnumber) => {
        if (sla.toLowerCase().includes("meet")){
            threePl_checking_meet(threePl_name, fsnumber);
            return;
        }
        else if (sla.toLowerCase().includes("fail")){
            threePl_checking_fail(threePl_name, fsnumber);
            return;
        }
    }

    const threePl_checking_meet = (threePl_checkMatch, fsnumber) => {
      dataStore.map((data) => {
        //if (Object.values(data).includes(threePl_checkMatch, fsnumber)) {
        if (Object.values(data).includes(threePl_checkMatch)) {
          Object.assign(data, { meet: data.meet + 1 });
          Object.assign(data, { total: data.total + 1 });
          Object.assign(data, {fsnumber: data.fsnumber.concat(fsnumber)});
        }
      });
    };

    const threePl_checking_fail = (threePl_checkMatch, fsnumber) => {
      dataStore.map((data) => {
        if (Object.values(data).includes(threePl_checkMatch)) {
          Object.assign(data, { fail: data.fail + 1 });
          Object.assign(data, { total: data.total + 1 });
          Object.assign(data, {fsnumber: data.fsnumber.concat(fsnumber)});
        }
      });
    };


    </script>
    <!-- <table id="resultTable"></table> -->
  </body>
</html>
